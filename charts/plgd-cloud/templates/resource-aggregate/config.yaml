{{- if .Values.resourceaggregate.enabled }}
{{- $raCert := "/certs" }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "plgd-cloud.resourceaggregate.configSecretName" . }}
  namespace: {{ .Release.Namespace }}
stringData:
  {{ .Values.coapgateway.config.fileName }}: |
    {{- with .Values.resourceaggregate }}
    log:
      debug: {{ .log.debug }}
    apis:
      grpc:
        address: {{ printf "0.0.0.0:%v" .port | quote }}
        ownerCacheExpiration: {{ .apis.grpc.ownerCacheExpiration | quote }}
        enforcementPolicy:
          minTime: {{ .apis.grpc.enforcementPolicy.minTime | quote }}
          permitWithoutStream: {{ .apis.grpc.enforcementPolicy.permitWithoutStream }}
        keepAlive:
          maxConnectionIdle: {{ .apis.grpc.keepAlive.maxConnectionIdle }}
          maxConnectionAge: {{ .apis.grpc.keepAlive.maxConnectionAge }}
          maxConnectionAgeGrace: {{ .apis.grpc.keepAlive.maxConnectionAgeGrace }}
          time: {{ .apis.grpc.keepAlive.time }}
          timeout: {{ .apis.grpc.keepAlive.timeout }}
        tls:
          {{- $tls := .apis.grpc.tls }}
          {{- include "plgd-cloud.certificateConfig" (list $ $tls $raCert) | indent 8 }}
          clientCertificateRequired: {{ .apis.grpc.tls.clientCertificateRequired }}
        authorization:
          ownerClaim:{{ printf " " }}{{ required "resourceaggregate.apis.grpc.authorization.ownerClaim or global.ownerClaim is required " ( .apis.grpc.authorization.ownerClaim | default $.Values.global.ownerClaim ) | quote }}
          authority:{{ printf " " }}{{ required "resourceaggregate.apis.grpc.authorization.authority or global.authority is required " ( .apis.grpc.authorization.authority | default $.Values.global.authority ) | quote }}
          audience:{{ printf " " }}{{ required "resourceaggregate.apis.grpc.authorization.audience or global.audience is required " ( .apis.grpc.authorization.audience | default $.Values.global.audience ) | quote }}
          http:
            maxIdleConns: {{ .apis.grpc.authorization.http.maxIdleConns }}
            maxConnsPerHost: {{ .apis.grpc.authorization.http.maxIdleConnsPerHost }}
            maxIdleConnsPerHost: {{ .apis.grpc.authorization.http.maxIdleConnsPerHost }}
            idleConnTimeout: {{ .apis.grpc.authorization.http.idleConnTimeout }}
            timeout: {{ .apis.grpc.authorization.http.timeout }}
            tls:
              {{- $grpcTls := .apis.grpc.authorization.http.tls }}
              {{- include "plgd-cloud.certificateConfig" (list $ $grpcTls $raCert) | indent 12 }}
              useSystemCAPool: {{ .apis.grpc.authorization.http.tls.useSystemCAPool }}
    clients:
      eventBus:
        nats:
          url:{{ printf " " }}{{- include "plgd-cloud.natsUri" (list $ .clients.eventBus.nats.url) | quote }}
          jetstream: {{ .clients.eventBus.nats.jetstream }}
          tls:
            {{- $natsTls := .clients.eventBus.nats.tls }}
            {{- include "plgd-cloud.certificateConfig" (list $ $natsTls $raCert) | indent 10 }}
            useSystemCAPool: {{ .clients.eventBus.nats.tls.useSystemCAPool }}
      eventStore:
        defaultCommandTTL: {{ .clients.eventStore.defaultCommandTTL }}
        snapshotThreshold: {{ .clients.eventStore.snapshotThreshold }}
        occMaxRetry: {{ .clients.eventStore.occMaxRetry }}
        mongoDB:
          uri:{{ printf " " }}{{- include "plgd-cloud.mongoDBUri" (list $ .clients.eventStore.mongoDB.uri)  | quote }}
          database: {{ .clients.eventStore.mongoDB.database }}
          batchSize: {{ .clients.eventStore.mongoDB.batchSize }}
          maxPoolSize: {{ .clients.eventStore.mongoDB.maxPoolSize }}
          maxConnIdleTime: {{ .clients.eventStore.mongoDB.maxConnIdleTime }}
          tls:
            {{- $mongoTls := .clients.eventStore.mongoDB.tls }}
            {{- include "plgd-cloud.certificateConfig" (list $ $natsTls $raCert) | indent 10 }}
            useSystemCAPool: {{ .clients.eventStore.mongoDB.tls.useSystemCAPool }}
      identityServer:
        grpc:
          {{- $authorizationServer := .clients.identityServer.grpc.address }}
          address:{{ printf " " }}{{- include "plgd-cloud.idenityAddress" (list $ $authorizationServer ) | quote }}
          keepAlive:
            time: {{ .clients.identityServer.grpc.keepAlive.timeout }}
            timeout: {{ .clients.identityServer.grpc.keepAlive.timeout }}
            permitWithoutStream: {{ .clients.identityServer.grpc.keepAlive.permitWithoutStream }}
          tls:
            {{- $authClientTls := .clients.identityServer.grpc.tls }}
            {{- include "plgd-cloud.certificateConfig" (list $ $authClientTls $raCert) | indent 10 }}
            useSystemCAPool: {{ .clients.identityServer.grpc.tls.useSystemCAPool }}
  {{- end }}
{{- end }}
