syntax = "proto3";

package resourceaggregate.pb;

import "resource-aggregate/pb/resources.proto";

option go_package = "github.com/plgd-dev/hub/v2/resource-aggregate/commands;commands";

message CommandMetadata {
    string connection_id = 1;
    uint64 sequence = 2;
}

message AuditContext {
    string user_id = 1;
    string correlation_id = 2;
}

message ResourceId {
    string device_id = 1;
    string href = 2;
}

//******************************************************************************************************************************************************
// Publish / Unpublish Resources
//
// ┌──────────┐          ┌───────┐             ┌──────────────────┐          ┌─────────┐
// │OCF Server│          │Gateway│             │Resource Aggregate│          │Event Bus│
// └──────────┘          └───┬───┘             └────────┬─────────┘          └─────────┘
//     ┌┴┐[UPDATE] '/oic/rd'┌┴┐                         │                         │
//     │ │ ───────────────> │ │                         │                         │
//     │ │                  │ │                         │                         │
//     │ │                  │ │ PublishResourceRequest  ┌┴┐                       │
//     │ │                  │ │ ───────────────────────>│ │                       │
//     │ │                  │ │                         │ │                       │
//     │ │                  │ │ PublishResourceResponse │ │                       │
//     │ │                  │ │ <───────────────────────│ │                       │
//     │ │                  └┬┘                         │ │                       │
//     │ │                   │                          │ │   ResourcePublished   │
//     │ │                   │                          │ │ ──────────────────────>
//     │ │                   │                          └┬┘                       │
//     │ │                  ┌┴┐                 ResourcePublished                 │
//     │ │                  │ │ <──────────────────────────────────────────────────
//     │ │                  │ │                         │                         │
//     │ │       OK         │ │                         │                         │
//     │ │ <─────────────── │ │                         │                         │
// ┌───└┬┘────┐          ┌──└┬┘──┐             ┌────────┴─────────┐          ┌─────────┐
// │OCF Server│          │Gateway│             │Resource Aggregate│          │Event Bus│
// └──────────┘          └───────┘             └──────────────────┘          └─────────┘
//******************************************************************************************************************************************************

// https://github.com/openconnectivityfoundation/cloud-services/blob/master/swagger2.0/oic.wk.rd.swagger.json#L35
message PublishResourceLinksRequest {
    repeated Resource resources = 1;
    string device_id = 2;
    CommandMetadata command_metadata = 3;
}

message PublishResourceLinksResponse {
    repeated Resource published_resources = 1;
    string device_id = 2;
    AuditContext audit_context = 3;
}

// https://github.com/openconnectivityfoundation/cloud-services/blob/master/swagger2.0/oic.wk.rd.swagger.json #Specification CR needed
message UnpublishResourceLinksRequest {
    repeated string hrefs = 1;
    string device_id = 2;
    CommandMetadata command_metadata = 3;
    repeated int64 instance_ids = 4; // used by device when sending unpublish request to RD
}

message UnpublishResourceLinksResponse {
    repeated string unpublished_hrefs = 1;
    string device_id = 2;
    AuditContext audit_context = 3;
}

//******************************************************************************************************************************************************
// Resource content changed
// (changed from the cloud or locally)
//
// ┌──────────┐                           ┌───────┐                    ┌──────────────────┐          ┌─────────┐
// │OCF Server│                           │Gateway│                    │Resource Aggregate│          │Event Bus│
// └──────────┘                           └───┬───┘                    └────────┬─────────┘          └─────────┘
//      │[NOTIFY] 'oic.r.temperature' changed┌┴┐                                │                         │
//      │ ──────────────────────────────────>│ │                                │                         │
//      │                                    │ │                                │                         │
//      │                                    │ │ NotifyResourceChangedRequest  ┌┴┐                        │
//      │                                    │ │ ─────────────────────────────>│ │                        │
//      │                                    └┬┘                               │ │                        │
//      │                                     │ NotifyResourceChangedResponse  │ │                        │
//      │                                     │ <──────────────────────────────│ │                        │
//      │                                     │                                └┬┘                        │
//      │                                     │                                 │     ResourceChanged     │
//      │                                     │                                 │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│
// ┌──────────┐                           ┌───┴───┐                    ┌────────┴─────────┐          ┌─────────┐
// │OCF Server│                           │Gateway│                    │Resource Aggregate│          │Event Bus│
// └──────────┘                           └───────┘                    └──────────────────┘          └─────────┘
//******************************************************************************************************************************************************

message NotifyResourceChangedRequest {
    ResourceId resource_id = 1;
    Content content = 2;
    CommandMetadata command_metadata = 3;
    Status status = 4;
}

message NotifyResourceChangedResponse {
    AuditContext audit_context = 3;
}

// batch of NotifyResourceChangedRequest
message BatchNotifyResourceChangedRequest {
    repeated NotifyResourceChangedRequest batch = 1;
}

message BatchNotifyResourceChangedResponse {
    AuditContext audit_context = 3;
}

//*******************************************************************************************************************************************************
// Update Resource
//
// ┌──────────┐                           ┌───────┐                    ┌──────────────────┐          ┌─────────┐          ┌──────┐
// │OCF Server│                           │Gateway│                    │Resource Aggregate│          │Event Bus│          │Client│
// └──────────┘                           └───┬───┘                    └────────┬─────────┘          └─────────┘          └──────┘
//      │                                     │                                ┌┴┐          UpdateResourceRequest           ┌┴┐
//      │                                     │                                │ │ <────────────────────────────────────────│ │
//      │                                     │                                │ │                        │                 │ │
//      │                                     │                                │ │          UpdateResourceResponse          │ │
//      │                                     │                                │ │ ────────────────────────────────────────>│ │
//      │                                     │                                └┬┘                        │                 │ │
//      │                                     │                                 │  ResourceUpdatePending  │                 │ │
//      │                                     │                                 │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                 │ │
//      │                                     │                                 │                         │                 │ │
//      │                                    ┌┴┐                  ResourceUpdatePending                   │                 │ │
//      │                                    │ │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │                 │ │
//      │                                    │ │                                │                         │                 │ │
//     ┌┴┐   [UPDATE] 'oic.r.temperature'    │ │                                │                         │                 │ │
//     │ │ <─────────────────────────────────│ │                                │                         │                 │ │
//     └┬┘                                   │ │                                │                         │                 │ │
//      │                 OK                 │ │                                │                         │                 │ │
//      │ ──────────────────────────────────>│ │                                │                         │                 │ │
//      │                                    │ │                                │                         │                 │ │
//      │                                    │ │ ConfirmResourceUpdateRequest  ┌┴┐                        │                 │ │
//      │                                    │ │ ─────────────────────────────>│ │                        │                 │ │
//      │                                    └┬┘                               │ │                        │                 │ │
//      │                                     │ ConfirmResourceUpdateResponse  │ │                        │                 │ │
//      │                                     │ <──────────────────────────────│ │                        │                 │ │
//      │                                     │                                └┬┘                        │                 │ │
//      │                                     │                                 │     ResourceUpdated     │                 │ │
//      │                                     │                                 │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                 │ │
//      │                                     │                                 │                         │                 └┬┘
//      │                                     │                                 │                         │ ResourceUpdated  │
//      │                                     │                                 │                         │ ─ ─ ─ ─ ─ ─ ─ ─ >│
//      │                                     │                                 │                         │                  │
//      │                                     │                                 │                         │                  │
//      │                                     │     ╔══════════════════════════╗│                         │                  │
// ═════╪═════════════════════════════════════╪═════╣ Resource content changed ╠╪═════════════════════════╪══════════════════╪═════════
//      │                                     │     ╚══════════════════════════╝│                         │                  │
//      │                                     │                                 │                         │                  │
//      │ [NOTIFY] 'oic.r.temperature' changed│                                 │                         │                  │
//      │ ────────────────────────────────────>                                 │                         │                  │
// ┌──────────┐                           ┌───┴───┐                    ┌────────┴─────────┐          ┌─────────┐          ┌──────┐
// │OCF Server│                           │Gateway│                    │Resource Aggregate│          │Event Bus│          │Client│
// └──────────┘                           └───────┘                    └──────────────────┘          └─────────┘          └──────┘
//*******************************************************************************************************************************************************

message UpdateResourceRequest {
    ResourceId resource_id = 1;
    string correlation_id = 2;
    Content content = 3;
    string resource_interface = 4;
    int64 time_to_live = 5; // command validity in nanoseconds. 0 means forever and minimal value is 100000000 (100ms).
    CommandMetadata command_metadata = 6;
}

message UpdateResourceResponse {
    int64 valid_until = 1; // unix timestamp in nanoseconds (https://golang.org/pkg/time/#Time.UnixNano) when command is considered as expired. 0 means forever.
    AuditContext audit_context = 2;
}

message ConfirmResourceUpdateRequest {
    ResourceId resource_id = 1;
    string correlation_id = 2;
    Status status = 3;
    Content content = 4;
    CommandMetadata command_metadata = 5;
}

message ConfirmResourceUpdateResponse {
    AuditContext audit_context = 1;
}

//*******************************************************************************************************************************************************
// Retrieve Resource
//
// ┌──────────┐            ┌───────┐                     ┌──────────────────┐           ┌─────────┐           ┌──────┐
// │OCF Server│            │Gateway│                     │Resource Aggregate│           │Event Bus│           │Client│
// └──────────┘            └───┬───┘                     └────────┬─────────┘           └─────────┘           └──────┘
//      │                      │                                  ┌┴┐          RetrieveResourceRequest           ┌┴┐
//      │                      │                                  │ │ <──────────────────────────────────────────│ │
//      │                      │                                  │ │                        │                   │ │
//      │                      │                                  │ │          RetrieveResourceResponse          │ │
//      │                      │                                  │ │ ──────────────────────────────────────────>│ │
//      │                      │                                  └┬┘                        │                   │ │
//      │                      │                                  │ ResourceRetrievePending  │                   │ │
//      │                      │                                  │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>│                   │ │
//      │                      │                                  │                          │                   │ │
//      │                     ┌┴┐                   ResourceRetrievePending                  │                   │ │
//      │                     │ │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─                   │ │
//      │                     │ │                                 │                          │                   │ │
//     ┌┴┐[RETRIEVE] '/oic/d' │ │                                 │                          │                   │ │
//     │ │ <───────────────── │ │                                 │                          │                   │ │
//     └┬┘                    │ │                                 │                          │                   │ │
//      │         OK          │ │                                 │                          │                   │ │
//      │ ───────────────────>│ │                                 │                          │                   │ │
//      │                     │ │                                 │                          │                   │ │
//      │                     │ │ ConfirmResourceRetrieveRequest  ┌┴┐                        │                   │ │
//      │                     │ │ ───────────────────────────────>│ │                        │                   │ │
//      │                     └┬┘                                 │ │                        │                   │ │
//      │                      │ConfirmResourceRetrieveResponse   │ │                        │                   │ │
//      │                      │<──────────────────────────────── │ │                        │                   │ │
//      │                      │                                  └┬┘                        │                   │ │
//      │                      │                                  │    ResourceRetrieved     │                   │ │
//      │                      │                                  │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>│                   │ │
//      │                      │                                  │                          │                   └┬┘
//      │                      │                                  │                          │ ResourceRetrieved │
//      │                      │                                  │                          │  ─ ─ ─ ─ ─ ─ ─ ─ ─>
// ┌──────────┐            ┌───┴───┐                     ┌────────┴─────────┐           ┌─────────┐           ┌──────┐
// │OCF Server│            │Gateway│                     │Resource Aggregate│           │Event Bus│           │Client│
// └──────────┘            └───────┘                     └──────────────────┘           └─────────┘           └──────┘
//*******************************************************************************************************************************************************

message RetrieveResourceRequest {
    ResourceId resource_id = 1;
    string correlation_id = 2;
    string resource_interface = 3;
    int64 time_to_live = 4; // command validity in nanoseconds. 0 means forever and minimal value is 100000000 (100ms).
    CommandMetadata command_metadata = 5;
}

message RetrieveResourceResponse {
    int64 valid_until = 1;  // unix timestamp in nanoseconds (https://golang.org/pkg/time/#Time.UnixNano) when command is considered as expired. 0 means forever.
    AuditContext audit_context = 2;
}

message ConfirmResourceRetrieveRequest {
    ResourceId resource_id = 1;
    string correlation_id = 2;
    Status status = 3;
    Content content = 4;
    CommandMetadata command_metadata = 5;
}

message ConfirmResourceRetrieveResponse {
    AuditContext audit_context = 1;
}

//*******************************************************************************************************************************************************
// Delete Resource
//
// ┌──────────┐             ┌───────┐                    ┌──────────────────┐          ┌─────────┐          ┌──────┐
// │OCF Server│             │Gateway│                    │Resource Aggregate│          │Event Bus│          │Client│
// └──────────┘             └───┬───┘                    └────────┬─────────┘          └─────────┘          └──────┘
//      │                       │                                ┌┴┐          DeleteResourceRequest           ┌┴┐
//      │                       │                                │ │ <────────────────────────────────────────│ │
//      │                       │                                │ │                        │                 │ │
//      │                       │                                │ │          DeleteResourceResponse          │ │
//      │                       │                                │ │ ────────────────────────────────────────>│ │
//      │                       │                                └┬┘                        │                 │ │
//      │                       │                                 │  ResourceDeletePending  │                 │ │
//      │                       │                                 │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                 │ │
//      │                       │                                 │                         │                 │ │
//      │                      ┌┴┐                  ResourceDeletePending                   │                 │ │
//      │                      │ │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │                 │ │
//      │                      │ │                                │                         │                 │ │
//     ┌┴┐ [DELETE] '/light/1' │ │                                │                         │                 │ │
//     │ │ <───────────────────│ │                                │                         │                 │ │
//     └┬┘                     │ │                                │                         │                 │ │
//      │          OK          │ │                                │                         │                 │ │
//      │ ────────────────────>│ │                                │                         │                 │ │
//      │                      │ │                                │                         │                 │ │
//      │                      │ │ ConfirmResourceDeleteRequest  ┌┴┐                        │                 │ │
//      │                      │ │ ─────────────────────────────>│ │                        │                 │ │
//      │                      └┬┘                               │ │                        │                 │ │
//      │                       │ ConfirmResourceDeleteResponse  │ │                        │                 │ │
//      │                       │ <──────────────────────────────│ │                        │                 │ │
//      │                       │                                └┬┘                        │                 │ │
//      │                       │                                 │     ResourceDeleted     │                 │ │
//      │                       │                                 │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                 │ │
//      │                       │                                 │                         │                 └┬┘
//      │                       │                                 │                         │ ResourceDeleted  │
//      │                       │                                 │                         │ ─ ─ ─ ─ ─ ─ ─ ─ >│
//      │                       │                                 │                         │                  │
//      │                       │                                 │                         │                  │
//      │                       │            ╔════════════════════╧══════╗                  │                  │
// ═════╪═══════════════════════╪════════════╣ Unpublish resource links  ╠══════════════════╪══════════════════╪═════════
//      │                       │            ╚════════════════════╤══════╝                  │                  │
//      │                       │                                 │                         │                  │
//      │ [UNPUBLISH] '/light/1'│                                 │                         │                  │
//      │ ──────────────────────>                                 │                         │                  │
// ┌──────────┐             ┌───┴───┐                    ┌────────┴─────────┐          ┌─────────┐          ┌──────┐
// │OCF Server│             │Gateway│                    │Resource Aggregate│          │Event Bus│          │Client│
// └──────────┘             └───────┘                    └──────────────────┘          └─────────┘          └──────┘
//*******************************************************************************************************************************************************

message DeleteResourceRequest {
    ResourceId resource_id = 1;
    string correlation_id = 2;
    int64 time_to_live = 3;  // command validity in nanoseconds. 0 means forever and minimal value is 100000000 (100ms).
    CommandMetadata command_metadata = 4;
}

message DeleteResourceResponse {
    int64 valid_until = 1;  // unix timestamp in nanoseconds (https://golang.org/pkg/time/#Time.UnixNano) when command is considered as expired. 0 means forever.
    AuditContext audit_context = 2;
}

message ConfirmResourceDeleteRequest {
    ResourceId resource_id = 1;
    string correlation_id = 2;
    Status status = 3;
    Content content = 4;
    CommandMetadata command_metadata = 5;
}

message ConfirmResourceDeleteResponse {
    AuditContext audit_context = 1;
}

//*******************************************************************************************************************************************************
// Create Resource
//
// ┌──────────┐           ┌───────┐                    ┌──────────────────┐          ┌─────────┐          ┌──────┐
// │OCF Server│           │Gateway│                    │Resource Aggregate│          │Event Bus│          │Client│
// └──────────┘           └───┬───┘                    └────────┬─────────┘          └─────────┘          └──────┘
//      │                     │                                ┌┴┐          CreateResourceRequest           ┌┴┐
//      │                     │                                │ │ <────────────────────────────────────────│ │
//      │                     │                                │ │                        │                 │ │
//      │                     │                                │ │          CreateResourceResponse          │ │
//      │                     │                                │ │ ────────────────────────────────────────>│ │
//      │                     │                                └┬┘                        │                 │ │
//      │                     │                                 │  ResourceCreatePending  │                 │ │
//      │                     │                                 │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                 │ │
//      │                     │                                 │                         │                 │ │
//      │                    ┌┴┐                  ResourceCreatePending                   │                 │ │
//      │                    │ │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │                 │ │
//      │                    │ │                                │                         │                 │ │
//     ┌┴┐ [CREATE] '/light' │ │                                │                         │                 │ │
//     │ │ <─────────────────│ │                                │                         │                 │ │
//     └┬┘                   │ │                                │                         │                 │ │
//      │         OK         │ │                                │                         │                 │ │
//      │ ──────────────────>│ │                                │                         │                 │ │
//      │                    │ │                                │                         │                 │ │
//      │                    │ │ ConfirmResourceCreateRequest  ┌┴┐                        │                 │ │
//      │                    │ │ ─────────────────────────────>│ │                        │                 │ │
//      │                    └┬┘                               │ │                        │                 │ │
//      │                     │ ConfirmResourceCreateResponse  │ │                        │                 │ │
//      │                     │ <──────────────────────────────│ │                        │                 │ │
//      │                     │                                └┬┘                        │                 │ │
//      │                     │                                 │     ResourceCreated     │                 │ │
//      │                     │                                 │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                 │ │
//      │                     │                                 │                         │                 └┬┘
//      │                     │                                 │                         │ ResourceCreated  │
//      │                     │                                 │                         │ ─ ─ ─ ─ ─ ─ ─ ─ >│
//      │                     │                                 │                         │                  │
//      │                     │                                 │                         │                  │
//      │                     │              ╔══════════════════╧══════╗                  │                  │
//══════╪═════════════════════╪══════════════╣ Publish resource links  ╠══════════════════╪══════════════════╪═════════
//      │                     │              ╚══════════════════╤══════╝                  │                  │
//      │                     │                                 │                         │                  │
//      │ [PUBLISH] '/light/1'│                                 │                         │                  │
//      │ ────────────────────>                                 │                         │                  │
// ┌──────────┐           ┌───┴───┐                    ┌────────┴─────────┐          ┌─────────┐          ┌──────┐
// │OCF Server│           │Gateway│                    │Resource Aggregate│          │Event Bus│          │Client│
// └──────────┘           └───────┘                    └──────────────────┘          └─────────┘          └──────┘
//*******************************************************************************************************************************************************

message CreateResourceRequest {
    ResourceId resource_id = 1;
    string correlation_id = 2;
    Content content = 3;
    int64 time_to_live = 4;  // command validity in nanoseconds. 0 means forever and minimal value is 100000000 (100ms).
    CommandMetadata command_metadata = 5;
}

message CreateResourceResponse {
    int64 valid_until = 1;  // unix timestamp in nanoseconds (https://golang.org/pkg/time/#Time.UnixNano) when command is considered as expired. 0 means forever.
    AuditContext audit_context = 2;
}

message ConfirmResourceCreateRequest {
    ResourceId resource_id = 1;
    string correlation_id = 2;
    Status status = 3;
    Content content = 4;
    CommandMetadata command_metadata = 5;
}

message ConfirmResourceCreateResponse {
    AuditContext audit_context = 1;
}


//*******************************************************************************************************************************************************
// Update Device Metadata - Connection status
//
// ┌──────────┐          ┌───────┐                  ┌──────────────────┐          ┌─────────┐
// │OCF Server│          │Gateway│                  │Resource Aggregate│          │Event Bus│
// └──────────┘          └───┬───┘                  └────────┬─────────┘          └─────────┘
//     ┌┴┐  SignInRequest   ┌┴┐                              ┌┴┐                       │
//     │ │ ───────────────> │ │                              │ │                       │
//     │ │                  │ │                              │ │                       │
//     │ │                  │ │ UpdateDeviceMetadataRequest  │ │                       │
//     │ │                  │ │ ────────────────────────────>│ │                       │
//     │ │                  │ │                              │ │                       │
//     │ │                  │ │ UpdateDeviceMetadataResponse │ │                       │
//     │ │                  │ │ <────────────────────────────│ │                       │
//     │ │                  └┬┘                              │ │                       │
//     │ │  SignInResponse   │                               │ │                       │
//     │ │ <─────────────────│                               │ │                       │
//     └┬┘                   │                               └┬┘                       │
//      │                    │                               │  DeviceMetadataUpdated  │
//      │                    │                               │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│
// ┌──────────┐          ┌───┴───┐                  ┌────────┴─────────┐          ┌─────────┐
// │OCF Server│          │Gateway│                  │Resource Aggregate│          │Event Bus│
// └──────────┘          └───────┘                  └──────────────────┘          └─────────┘
//*******************************************************************************************************************************************************

message Connection {
    enum Status {
        OFFLINE = 0;
        ONLINE = 1;
    };
    Status status = 1;
    int64 status_valid_until = 2;
    string id = 3; // when status is ONLINE, this field contains the connection id. To update state offline, this field must be same as the one in the previous message.
    int64 connected_at = 4; // timestamp when the device was connected
}
//*******************************************************************************************************************************************************
// Update Device Metadata - Shadow Synchronization Status
//
// ┌──────────┐          ┌───────┐                         ┌──────────────────┐               ┌─────────┐               ┌──────┐
// │OCF Server│          │Gateway│                         │Resource Aggregate│               │Event Bus│               │Client│
// └──────────┘          └───┬───┘                         └────────┬─────────┘               └─────────┘               └──────┘
//     ┌┴┐                   │                                      ┌┴┐            UpdateDeviceMetadataRequest             ┌┴┐
//     │ │                   │                                      │ │ <──────────────────────────────────────────────────│ │
//     │ │                   │                                      │ │                            │                       │ │
//     │ │                   │                                      │ │            UpdateDeviceMetadataResponse            │ │
//     │ │                   │                                      │ │ ──────────────────────────────────────────────────>│ │
//     │ │                   │                                      └┬┘                            │                       │ │
//     │ │                   │                                      │ DeviceMetadataUpdatePending  │                       │ │
//     │ │                   │                                      │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>│                       │ │
//     │ │                   │                                      │                              │                       │ │
//     │ │                  ┌┴┐                     DeviceMetadataUpdatePending                    │                       │ │
//     │ │                  │ │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─                       │ │
//     │ │                  │ │                                     │                              │                       │ │
//     │ │                  │ │ ConfirmDeviceMetadataUpdateRequest  ┌┴┐                            │                       │ │
//     │ │                  │ │ ───────────────────────────────────>│ │                            │                       │ │
//     │ │                  └┬┘                                     │ │                            │                       │ │
//     │ │                   │ConfirmDeviceMetadataUpdateResponse   │ │                            │                       │ │
//     │ │                   │<──────────────────────────────────── │ │                            │                       │ │
//     │ │                   │                                      └┬┘                            │                       │ │
//     │ │                   │                                      │    DeviceMetadataUpdated     │                       │ │
//     │ │                   │                                      │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>│                       │ │
//     └┬┘                   │                                      │                              │                       └┬┘
//      │                    │                                      │                              │ DeviceMetadataUpdated │
//      │                    │                                      │                              │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>
// ┌──────────┐          ┌───┴───┐                         ┌────────┴─────────┐               ┌─────────┐               ┌──────┐
// │OCF Server│          │Gateway│                         │Resource Aggregate│               │Event Bus│               │Client│
// └──────────┘          └───────┘                         └──────────────────┘               └─────────┘               └──────┘
//*******************************************************************************************************************************************************

message ShadowSynchronization {
    enum Status {
        NONE = 0;
        STARTED = 1;
        FINISHED = 2;
    };
    bool enabled = 1; // by default true
    Status status = 2; // if status is changed to finished but during the synchronization the shadow synchronization was disabled, command is ignored and `enabled` stays disabled
    int64 started_at = 3;  // unix timestamp in nanoseconds (https://golang.org/pkg/time/#Time.UnixNano) when shadow synchronization started.
    int64 finished_at = 4; // unix timestamp in nanoseconds (https://golang.org/pkg/time/#Time.UnixNano) when shadow synchronization finished.
    CommandMetadata command_metadata = 5; // when status is STARTED, this field contains the connection id. To update state to FINISHED, this field must be same as the one in the previous message.
}

message UpdateDeviceMetadataRequest {
    string device_id = 1;
    string correlation_id = 2;
    oneof update {
        Connection connection = 3;
        ShadowSynchronization shadow_synchronization = 4;
    };
    int64 time_to_live = 5;  // command validity in nanoseconds. 0 means forever and minimal value is 100000000 (100ms).
    CommandMetadata command_metadata = 6;
}

message UpdateDeviceMetadataResponse {
    int64 valid_until = 1;  // unix timestamp in nanoseconds (https://golang.org/pkg/time/#Time.UnixNano) when command is considered as expired. 0 means forever.
    AuditContext audit_context = 2;
}

message ConfirmDeviceMetadataUpdateRequest {
    string device_id = 1;
    string correlation_id = 2;
    Status status = 3;
    oneof confirm {
        ShadowSynchronization shadow_synchronization = 4;
    };
    CommandMetadata command_metadata = 5;
}

message ConfirmDeviceMetadataUpdateResponse {
    AuditContext audit_context = 1;
}

//*******************************************************************************************************************************************************
// Cancel resource command - similar for all Update/Retrieve/Create/Delete commands
// ┌──────────────────┐                       ┌─────────┐          ┌──────┐          ┌──────────┐
// │Resource Aggregate│                       │Event Bus│          │Client│          │OCF Server│
// └────────┬─────────┘                       └─────────┘          └──────┘          └──────────┘
//          │                                      │                  │                   │  ╔════════════════════════════╗
//          │                                      │                  │                   │  ║OCF Server is disconnected ░║
//          │                                      │                  │                   │  ║from the plgd hub         ║
//          │                                      │                  │                   │  ╚════════════════════════════╝
//         ┌┴┐                RetrieveResourceRequest                ┌┴┐                  │
//         │ │ <─────────────────────────────────────────────────────│ │                  │
//         │ │                                     │                 │ │                  │
//         │ │       ResourceRetrievePending       │                 │ │                  │
//         │ │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                 │ │                  │
//         └┬┘                                     │                 └┬┘                  │
//          │                 RetrieveResourceResponse                │                   │
//          │ ────────────────────────────────────────────────────────>                   │
//          │                                      │                  │                   │
//         ┌┴┐              CancelPendingCommandsRequest              │                   │
//         │ │ <──────────────────────────────────────────────────────│                   │
//         │ │                                     │                  │                   │
//         │ │ ResourceRetrieved (status=Canceled) │                  │                   │
//         │ │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                  │                   │
//         └┬┘                                     │                  │                   │
//          │              CancelPendingCommandsResponse              │                   │
//          │ ────────────────────────────────────────────────────────>                   │
// ┌────────┴─────────┐                       ┌─────────┐          ┌──────┐          ┌──────────┐
// │Resource Aggregate│                       │Event Bus│          │Client│          │OCF Server│
// └──────────────────┘                       └─────────┘          └──────┘          └──────────┘
//*******************************************************************************************************************************************************

message CancelPendingCommandsRequest {
    ResourceId resource_id = 1;
    repeated string correlation_id_filter = 2; // empty array means all.
    CommandMetadata command_metadata = 100;
}

message CancelPendingCommandsResponse{
    repeated string correlation_ids = 1; // list of cancelled correlation id
    AuditContext audit_context = 100;
}

//*******************************************************************************************************************************************************
// Cancel update device metadata - Shadow Synchronization Status
// ┌──────────────────┐                         ┌─────────┐          ┌──────┐          ┌──────────┐
// │Resource Aggregate│                         │Event Bus│          │Client│          │OCF Server│
// └────────┬─────────┘                         └─────────┘          └──────┘          └──────────┘
//          │                                        │                  │                   │  ╔════════════════════════════╗
//          │                                        │                  │                   │  ║OCF Server is disconnected ░║
//          │                                        │                  │                   │  ║from the plgd hub         ║
//          │                                        │                  │                   │  ╚════════════════════════════╝
//         ┌┴┐               UpdateDeviceMetadataRequest               ┌┴┐                  │
//         │ │ <───────────────────────────────────────────────────────│ │                  │
//         │ │                                       │                 │ │                  │
//         │ │      DeviceMetadataUpdatePending      │                 │ │                  │
//         │ │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                 │ │                  │
//         └┬┘                                       │                 └┬┘                  │
//          │                UpdateDeviceMetadataResponse               │                   │
//          │ ──────────────────────────────────────────────────────────>                   │
//          │                                        │                  │                   │
//         ┌┴┐           CancelPendingMetadataUpdatesRequest           ┌┴┐                  │
//         │ │ <───────────────────────────────────────────────────────│ │                  │
//         │ │                                       │                 │ │                  │
//         │ │ DeviceMetadataUpdated (Canceled=true) │                 │ │                  │
//         │ │  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ >│                 │ │                  │
//         └┬┘                                       │                 └┬┘                  │
//          │            CancelPendingMetadataUpdatesResponse           │                   │
//          │ ──────────────────────────────────────────────────────────>                   │
// ┌────────┴─────────┐                         ┌─────────┐          ┌──────┐          ┌──────────┐
// │Resource Aggregate│                         │Event Bus│          │Client│          │OCF Server│
// └──────────────────┘                         └─────────┘          └──────┘          └──────────┘
//*******************************************************************************************************************************************************

message CancelPendingMetadataUpdatesRequest {
    string device_id = 1;
    repeated string correlation_id_filter = 2; // empty array means all.
    CommandMetadata command_metadata = 100;
}

message CancelPendingMetadataUpdatesResponse {
    repeated string correlation_ids = 1; // list of cancelled correlation id
    AuditContext audit_context = 100;
}

//*************************************************************************************************************************************************
// Delete Devices
//
// ┌──────┐                 ┌───────┐            ┌──────────────────┐          ┌──────────────┐          ┌─────────┐          ┌────────────┐          ┌──────────┐
// │Client│                 │Gateway│            │Resource Aggregate│          │Identity Store│          │Event Bus│          │CoAP Gateway│          │OCF Server│
// └──────┘                 └───┬───┘            └────────┬─────────┘          └───────┬──────┘          └─────────┘          └─────┬──────┘          └──────────┘
//   ┌┴┐ DeleteDevicesRequest  ┌┴┐                        │                            │                      │                     │                      │
//   │ │ ─────────────────────>│ │                        │                            │                      │                     │                      │
//   │ │                       │ │                        │                            │                      │                     │                      │
//   │ │                       │ │ DeleteDevicesRequest  ┌┴┐                           │                      │                     │                      │
//   │ │                       │ │ ─────────────────────>│ │                           │                      │                     │                      │
//   │ │                       │ │                       └┬┘                           │                      │                     │                      │
//   │ │                       │ │ DeleteDevicesResponse  │                            │                      │                     │                      │
//   │ │                       │ │ <──────────────────────│                            │                      │                     │                      │
//   │ │                       │ │                        │                            │                      │                     │                      │
//   │ │                       │ │                 DeleteDevicesRequest               ┌┴┐                     │                     │                      │
//   │ │                       │ │ ──────────────────────────────────────────────────>│ │                     │                     │                      │
//   │ │                       │ │                        │                           └┬┘                     │                     │                      │
//   │ │                       │ │                 DeleteDevicesResponse               │                      │                     │                      │
//   │ │                       │ │ <───────────────────────────────────────────────────│                      │                     │                      │
//   │ │                       │ │                        │                            │                      │                     │                      │
//   │ │                       │ │                        │                            │    DevicesDeleted    │                     │                      │
//   │ │                       │ │                        │                            │─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>│                     │                      │
//   └┬┘                       └┬┘                        │                            │                      │                     │                      │
//    │  DeleteDevicesResponse  │                         │                            │                      │                     │                      │
//    │ <────────────────────────                         │                            │                      │                     │                      │
//    │                         │                         │                            │                      │                     │                      │
//    │                         │                         │                            │                      │   DevicesDeleted    │                     \│/
//    │                         │                         │                            │                      │ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>│                      X
//    │                         │                         │                            │                      │                     │                     /│\
//    │                         │                         │                            │                      │                     │      Disconnect      │
//    │                         │                         │                            │                      │                     │ ─────────────────────>
// ┌──────┐                 ┌───┴───┐            ┌────────┴─────────┐          ┌───────┴──────┐          ┌─────────┐          ┌─────┴──────┐          ┌──────────┐
// │Client│                 │Gateway│            │Resource Aggregate│          │Identity Store│          │Event Bus│          │CoAP Gateway│          │OCF Server│
// └──────┘                 └───────┘            └──────────────────┘          └──────────────┘          └─────────┘          └────────────┘          └──────────┘
//*************************************************************************************************************************************************

message DeleteDevicesRequest {
    repeated string device_ids = 1;
}

message DeleteDevicesResponse {
    repeated string device_ids = 1;
    AuditContext audit_context = 100;
}
