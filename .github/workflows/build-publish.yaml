# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Create and publish a docker images to github

# concurrency:
#   group: ${{ github.workflow }}-${{ github.ref }}
#   cancel-in-progress: ${{ github.ref_name != 'main' }}

on:
  push:
    branches:
      - main
    tags:
      - "*"
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  build-and-publish-image:
    strategy:
      fail-fast: false
      matrix:
        include:
        - name: resource-aggregate
          directory: resource-aggregate
          file: .tmp/docker/resource-aggregate/Dockerfile
          template_file: tools/docker/Dockerfile.in
        # - name: resource-directory
        #   directory: resource-directory
        #   file: .tmp/docker/resource-directory/Dockerfile
        #   template_file: tools/docker/Dockerfile.in
        # - name: coap-gateway
        #   directory: coap-gateway
        #   file: .tmp/docker/coap-gateway/Dockerfile
        #   template_file: tools/docker/Dockerfile.in
        # - name: cloud2cloud-connector
        #   directory: cloud2cloud-connector
        #   file: .tmp/docker/cloud2cloud-connector/Dockerfile
        #   template_file: tools/docker/Dockerfile.in
        # - name: cloud2cloud-gateway
        #   directory: cloud2cloud-gateway
        #   file: .tmp/docker/cloud2cloud-gateway/Dockerfile
        #   template_file: tools/docker/Dockerfile.in
        # - name: certificate-authority
        #   directory: certificate-authority
        #   file: .tmp/docker/certificate-authority/Dockerfile
        #   template_file: tools/docker/Dockerfile.in
        # - name: grpc-gateway
        #   directory: grpc-gateway
        #   file: .tmp/docker/grpc-gateway/Dockerfile
        #   template_file: tools/docker/Dockerfile.in
        # - name: http-gateway
        #   directory: http-gateway
        #   file: http-gateway/Dockerfile
        # - name: identity-store
        #   directory: identity-store
        #   file: .tmp/docker/identity-store/Dockerfile
        #   template_file: tools/docker/Dockerfile.in
        # - name: mock-oauth-server
        #   directory: test/oauth-server
        #   file: .tmp/docker/mock-oauth-server/Dockerfile
        #   template_file: tools/docker/Dockerfile.in
        # - name: bundle
        #   directory: bundle
        #   file: bundle/Dockerfile
        # - name: test-cloud-server
        #   directory: test/cloud-server
        #   file: test/cloud-server/Dockerfile
        # - name: cert-tool
        #   directory: tools/cert-tool
        #   file: tools/cert-tool/Dockerfile
        # coap-gateway builded by Golang 1.19.4 has an issue with TLS handshake.
        # This issue is reproducible with real devices that connect to AWS.
        # This seems to be caused by the device's old mbedtls library:
        # https://github.com/Mbed-TLS/mbedtls/tree/d81c11b8ab61fd5b2da8133aa73c5fe33a0633eb
        # - name: coap-gateway-go1-18
        #   directory: coap-gateway
        #   file: tools/docker/Dockerfile.go1.18

    uses: ./.github/workflows/build-publish-cfg.yaml
    with:
      name: ${{ matrix.name }}
      directory: ${{ matrix.directory }}
      file: ${{ matrix.file }}
      release: 2.7.12
      template_file: ${{ matrix.template_file }}
